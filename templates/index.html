<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawing Comparator</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', Arial, sans-serif;
            background: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%, #21d4fd 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.5s;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2.5rem 2rem 2rem 2rem;
            border-radius: 2rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
            max-width: 420px;
            width: 100%;
            text-align: center;
            position: relative;
            animation: popIn 0.7s cubic-bezier(.68,-0.55,.27,1.55);
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .ai-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #21d4fd 0%, #b721ff 100%);
            border-radius: 50%;
            box-shadow: 0 0 24px 4px #b721ff44, 0 2px 8px #21d4fd33;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 24px 4px #b721ff44, 0 2px 8px #21d4fd33; }
            100% { box-shadow: 0 0 36px 12px #21d4fd66, 0 2px 16px #b721ff33; }
        }
        .ai-icon svg {
            width: 36px;
            height: 36px;
            fill: white;
        }
        h1 {
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 1.2rem;
            color: #3a3a5a;
            letter-spacing: 1px;
        }
        .file-upload {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .file-upload label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #5a5a7a;
        }
        .file-upload input[type="file"] {
            display: block;
            width: 100%;
            padding: 0.5rem;
            border-radius: 1rem;
            border: 1.5px solid #e0e0f0;
            background: #f7f8fa;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            transition: border 0.2s;
        }
        .file-upload input[type="file"]:focus {
            border: 1.5px solid #21d4fd;
            outline: none;
        }
        button {
            background: linear-gradient(90deg, #21d4fd 0%, #b721ff 100%);
            color: white;
            padding: 0.8rem 2.2rem;
            border: none;
            border-radius: 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px #b721ff22;
            transition: background 0.2s, transform 0.1s;
        }
        button:hover {
            background: linear-gradient(90deg, #b721ff 0%, #21d4fd 100%);
            transform: scale(1.04);
        }
        .result {
            margin-top: 2rem;
            padding: 1.2rem;
            border-radius: 1.2rem;
            background: #f0f6ff;
            box-shadow: 0 2px 8px #21d4fd11;
            display: none;
            text-align: left;
            animation: fadeIn 0.7s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .error {
            color: #ff3b3b;
            margin-top: 1rem;
            display: none;
            font-weight: 600;
            background: #fff0f0;
            border-radius: 1rem;
            padding: 0.7rem 1rem;
        }
        .differences {
            margin-top: 0.7rem;
            font-family: 'Fira Mono', monospace;
            white-space: pre-wrap;
            background: #eaf6ff;
            padding: 0.8rem;
            border-radius: 0.8rem;
            color: #3a3a5a;
            font-size: 0.98rem;
        }
        .disclaimer {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 0.8rem;
            background: #f0f6ff;
            text-align: left;
            font-size: 0.9rem;
            color: #3a3a5a;
        }
        .file-info {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background: #fff8dc;
            font-size: 0.8rem;
            color: #8b4513;
            text-align: center;
        }
        @media (max-width: 600px) {
            .container {
                padding: 1.2rem 0.5rem 1.5rem 0.5rem;
                max-width: 98vw;
            }
            h1 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="ai-icon">
            <!-- AI/robot icon SVG -->
            <svg viewBox="0 0 48 48"><circle cx="24" cy="24" r="20" fill="#fff" opacity="0.15"/><ellipse cx="24" cy="30" rx="10" ry="6" fill="#fff" opacity="0.2"/><circle cx="24" cy="24" r="14" fill="#21d4fd" opacity="0.7"/><ellipse cx="24" cy="24" rx="10" ry="10" fill="#b721ff" opacity="0.5"/><circle cx="24" cy="24" r="7" fill="#fff"/><circle cx="21" cy="22" r="1.5" fill="#21d4fd"/><circle cx="27" cy="22" r="1.5" fill="#b721ff"/></svg>
        </div>
        <h1>Drawing Comparator</h1>
        <form id="uploadForm">
            <div class="file-upload">
                <label for="file1">Upload First Drawing:</label>
                <input type="file" id="file1" name="file1" accept=".png,.jpg,.jpeg,.pdf" required>
                <div id="file1Info" class="file-info" style="display:none;"></div>
            </div>
            <div class="file-upload">
                <label for="file2">Upload Second Drawing:</label>
                <input type="file" id="file2" name="file2" accept=".png,.jpg,.jpeg,.pdf" required>
                <div id="file2Info" class="file-info" style="display:none;"></div>
            </div>
            <button type="submit">Compare Drawings</button>
        </form>
        <div id="error" class="error"></div>
        <div id="result" class="result">
            <h3>Comparison Results</h3>
            <div id="comparisonMethod" style="margin-bottom: 1rem; padding: 0.5rem; background: #f0f8ff; border-radius: 0.5rem; font-size: 0.9rem;"></div>
            <p>Similarity Score: <span id="similarityScore"></span></p>
            <div id="aiAnalysis" style="display: none;">
                <h4>ü§ñ AI Analysis</h4>
                <p>Confidence: <span id="aiConfidence"></span></p>
                <div id="aiReasoning" style="background: #f8f9fa; padding: 0.8rem; border-radius: 0.5rem; margin: 0.5rem 0; font-style: italic;"></div>
                <div id="categoryAnalysis" style="margin: 0.5rem 0;"></div>
            </div>
            <h4>Key Differences:</h4>
            <div id="differences" class="differences"></div>
            <div id="technicalAnalysis" style="display: none; margin-top: 1rem;">
                <h4>üìã Technical Analysis</h4>
                <div id="technicalDetails"></div>
            </div>
        </div>
        <button id="downloadBtn" style="display:none;margin-top:1rem;">Download Result</button>
        <div class="disclaimer">
            <span role="img" aria-label="ai">ü§ñ</span> <b>File Size Limits:</b> Maximum 20MB per file (Google Vision API limit).<br>
            <b>Supported formats:</b> PNG, JPG, JPEG, PDF.<br>
            <span role="img" aria-label="info">‚ÑπÔ∏è</span> Large files may take longer to process.
        </div>
    </div>

    <script>
        let lastResult = null;
        
        // Function to format file size
        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }
        
        // File input change handlers
        document.getElementById('file1').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const infoDiv = document.getElementById('file1Info');
            if (file) {
                const size = formatFileSize(file.size);
                const maxSize = 20 * 1024 * 1024; // 20MB
                infoDiv.textContent = `File size: ${size}`;
                infoDiv.style.display = 'block';
                if (file.size > maxSize) {
                    infoDiv.style.background = '#ffe6e6';
                    infoDiv.style.color = '#cc0000';
                    infoDiv.textContent += ' ‚ö†Ô∏è File too large (max 20MB)';
                } else {
                    infoDiv.style.background = '#e6ffe6';
                    infoDiv.style.color = '#006600';
                    infoDiv.textContent += ' ‚úì Size OK';
                }
            } else {
                infoDiv.style.display = 'none';
            }
        });
        
        document.getElementById('file2').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const infoDiv = document.getElementById('file2Info');
            if (file) {
                const size = formatFileSize(file.size);
                const maxSize = 20 * 1024 * 1024; // 20MB
                infoDiv.textContent = `File size: ${size}`;
                infoDiv.style.display = 'block';
                if (file.size > maxSize) {
                    infoDiv.style.background = '#ffe6e6';
                    infoDiv.style.color = '#cc0000';
                    infoDiv.textContent += ' ‚ö†Ô∏è File too large (max 20MB)';
                } else {
                    infoDiv.style.background = '#e6ffe6';
                    infoDiv.style.color = '#006600';
                    infoDiv.textContent += ' ‚úì Size OK';
                }
            } else {
                infoDiv.style.display = 'none';
            }
        });
        
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file1', document.getElementById('file1').files[0]);
            formData.append('file2', document.getElementById('file2').files[0]);
            
            try {
                const response = await fetch('/compare', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    const data = await response.json();
                    lastResult = data;
                    document.getElementById('error').style.display = 'none';
                    document.getElementById('result').style.display = 'block';
                    
                    // Display basic similarity score
                    document.getElementById('similarityScore').textContent = 
                        `${(data.similarity_score * 100).toFixed(2)}%`;
                    
                    // Show comparison method
                    const methodDiv = document.getElementById('comparisonMethod');
                    const methodIcon = data.comparison_method === 'ai' ? 'ü§ñ' : 
                                     data.comparison_method === 'basic_fallback' ? '‚ö†Ô∏è' : 'üìä';
                    methodDiv.textContent = `${methodIcon} Analysis Method: ${data.comparison_method.replace('_', ' ').toUpperCase()}`;
                    
                    // Show raw similarity if different from AI similarity
                    if (data.raw_similarity && Math.abs(data.raw_similarity - data.similarity_score) > 0.01) {
                        document.getElementById('similarityScore').textContent += 
                            ` (Text similarity: ${(data.raw_similarity * 100).toFixed(1)}%)`;
                    }
                    
                    // Display AI analysis if available
                    if (data.ai_analysis) {
                        const aiDiv = document.getElementById('aiAnalysis');
                        aiDiv.style.display = 'block';
                        
                        document.getElementById('aiConfidence').textContent = 
                            `${(data.ai_analysis.confidence * 100).toFixed(1)}%`;
                        
                        document.getElementById('aiReasoning').textContent = 
                            data.ai_analysis.reasoning || 'No reasoning provided';
                        
                        // Display category analysis
                        if (data.ai_analysis.categories) {
                            const categoryDiv = document.getElementById('categoryAnalysis');
                            let categoryHtml = '<h5>Category Breakdown:</h5>';
                            for (const [category, score] of Object.entries(data.ai_analysis.categories)) {
                                const percentage = (score * 100).toFixed(1);
                                const barColor = score > 0.8 ? '#4CAF50' : score > 0.5 ? '#FF9800' : '#F44336';
                                categoryHtml += `
                                    <div style="margin: 0.3rem 0;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>${category.replace('_', ' ').toUpperCase()}</span>
                                            <span>${percentage}%</span>
                                        </div>
                                        <div style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                                            <div style="background: ${barColor}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                            }
                            categoryDiv.innerHTML = categoryHtml;
                        }
                        
                        // Display technical analysis
                        if (data.ai_analysis.technical_analysis) {
                            const techDiv = document.getElementById('technicalAnalysis');
                            const techDetails = document.getElementById('technicalDetails');
                            techDiv.style.display = 'block';
                            
                            let techHtml = '';
                            const analysis = data.ai_analysis.technical_analysis;
                            
                            if (analysis.major_differences && analysis.major_differences.length > 0) {
                                techHtml += '<h6>üî¥ Major Differences:</h6><ul>';
                                analysis.major_differences.forEach(diff => {
                                    techHtml += `<li>${diff}</li>`;
                                });
                                techHtml += '</ul>';
                            }
                            
                            if (analysis.critical_discrepancies && analysis.critical_discrepancies.length > 0) {
                                techHtml += '<h6>‚ö†Ô∏è Critical Discrepancies:</h6><ul>';
                                analysis.critical_discrepancies.forEach(disc => {
                                    techHtml += `<li style="color: #d32f2f; font-weight: bold;">${disc}</li>`;
                                });
                                techHtml += '</ul>';
                            }
                            
                            if (analysis.common_elements && analysis.common_elements.length > 0) {
                                techHtml += '<h6>‚úÖ Common Elements:</h6><ul>';
                                analysis.common_elements.slice(0, 3).forEach(elem => {
                                    techHtml += `<li style="color: #388e3c;">${elem}</li>`;
                                });
                                techHtml += '</ul>';
                            }
                            
                            techDetails.innerHTML = techHtml || '<p>No detailed technical analysis available.</p>';
                        }
                    }
                    
                    // Display differences
                    const differencesText = Array.isArray(data.differences) && data.differences.length > 0 ? 
                        data.differences.join('\n') : 'No major differences detected.';
                    document.getElementById('differences').textContent = differencesText;
                    
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    let errorMessage = errorData.error || 'An error occurred.';
                    
                    // Add file size info if available
                    if (errorData.file_size) {
                        errorMessage += ` (File size: ${errorData.file_size})`;
                    }
                    
                    // Handle specific error codes
                    if (response.status === 413) {
                        errorMessage += '\n\nTip: Try compressing your image or using a smaller file.';
                    }
                    
                    document.getElementById('error').textContent = errorMessage;
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('result').style.display = 'none';
                    document.getElementById('downloadBtn').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('result').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'none';
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', async () => {
            if (!lastResult) return;
            try {
                const response = await fetch('/download_result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(lastResult)
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'comparison_result.json';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to download result.');
                }
            } catch (error) {
                alert('Failed to download result.');
            }
        });
    </script>
</body>
</html>